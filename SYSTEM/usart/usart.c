#include "sys.h"
#include "usart.h"	
#include "bsp.h"
#include "stm32f4xx_dma.h"
#include <stdarg.h>


//////////////////////////////////////////////////////////////////
//?¨®¨¨?¨°???¡ä¨²??,?¡ì3?printfo¡¥¨ºy,??2?D¨¨¨°a????use MicroLIB	  
#if 1
#pragma import(__use_no_semihosting)             
//¡À¨º¡Á??aD¨¨¨°a¦Ì??¡ì3?o¡¥¨ºy                 
struct __FILE 
{ 
	int handle; 
}; 

FILE __stdout;       
//?¡§¨°?_sys_exit()¨°?¡À¨¹?a¨º1¨®?¡ã??¡Â?¨²?¡ê¨º?    
void _sys_exit(int x) 
{ 
	x = x; 
} 
//???¡§¨°?fputco¡¥¨ºy 
int fputc(int ch, FILE *f)
{ 	
	while((USART3->SR&0X40)==0);//?-?¡¤¡¤¡é?¨ª,?¡À¦Ì?¡¤¡é?¨ª¨ª¨º¡À?   
	USART3->DR = (u8) ch;      
	return ch;
}
#endif







































char RxDebugMsg[DEBUG_MSG_LENGTH];
char TxDebugMsg[DEBUG_MSG_LENGTH];

void uart_init(u32 bound1,u32 bound2){
   //GPIO???¨²¨¦¨¨??
  GPIO_InitTypeDef GPIO_InitStructure;
	USART_InitTypeDef USART_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;
	DMA_InitTypeDef  DMA_InitStructure;
	
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA|RCC_AHB1Periph_GPIOB|RCC_AHB1Periph_GPIOC|RCC_AHB1Periph_GPIOD|RCC_AHB1Periph_GPIOG,ENABLE);
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART3, ENABLE);	 
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_USART6,ENABLE);//¨º1?¨¹USART1o¨ªUSART6¨º¡À?¨®
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2|RCC_APB1Periph_USART3|RCC_APB1Periph_UART4|RCC_APB1Periph_UART5,ENABLE);
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_DMA2,ENABLE);   //?aDMA2
	
	DMA_DeInit(DMA2_Stream1);
	while (DMA_GetCmdStatus(DMA2_Stream1) != DISABLE){}//¦Ì¨¨¡äyDMA?¨¦???? 
	

		
		
		
	/*3?¨º??¡¥DMA   USART6_RX*/  
	DMA_InitStructure.DMA_Channel               = DMA_Channel_5; 
  DMA_InitStructure.DMA_PeripheralBaseAddr    = (u32)(&(USART6->DR));
  DMA_InitStructure.DMA_Memory0BaseAddr       = (uint32_t)RxDebugMsg;
  DMA_InitStructure.DMA_DIR                   = DMA_DIR_PeripheralToMemory;
  DMA_InitStructure.DMA_BufferSize            = DEBUG_MSG_LENGTH;
  DMA_InitStructure.DMA_PeripheralInc         = DMA_PeripheralInc_Disable;
  DMA_InitStructure.DMA_MemoryInc             = DMA_MemoryInc_Enable;
  DMA_InitStructure.DMA_PeripheralDataSize    = DMA_PeripheralDataSize_Byte;
  DMA_InitStructure.DMA_MemoryDataSize        = DMA_MemoryDataSize_Byte;
  DMA_InitStructure.DMA_Mode                  = DMA_Mode_Normal;
  DMA_InitStructure.DMA_Priority              = DMA_Priority_Medium;
  DMA_InitStructure.DMA_FIFOMode              = DMA_FIFOMode_Disable;         
  DMA_InitStructure.DMA_FIFOThreshold         = DMA_FIFOThreshold_Full;
  DMA_InitStructure.DMA_MemoryBurst           = DMA_MemoryBurst_Single;
  DMA_InitStructure.DMA_PeripheralBurst       = DMA_PeripheralBurst_Single;
  DMA_Init(DMA2_Stream1, &DMA_InitStructure);
	
	DMA_DeInit(DMA2_Stream6);
	while (DMA_GetCmdStatus(DMA2_Stream6) != DISABLE){}//¦Ì¨¨¡äyDMA?¨¦???? 

	/*3?¨º??¡¥DMA   USART6_TX*/  
	DMA_InitStructure.DMA_Channel               = DMA_Channel_5; 
  DMA_InitStructure.DMA_PeripheralBaseAddr    = (u32)(&(USART6->DR));
  DMA_InitStructure.DMA_Memory0BaseAddr       = (uint32_t)TxDebugMsg;
  DMA_InitStructure.DMA_DIR                   = DMA_DIR_MemoryToPeripheral;
  DMA_InitStructure.DMA_BufferSize            = 0;   //¡¤¡ä?y???¨¢¡À?¡ê?2?¨¨?¨¦?¦Ì??¨ª??0
  DMA_InitStructure.DMA_PeripheralInc         = DMA_PeripheralInc_Disable;
  DMA_InitStructure.DMA_MemoryInc             = DMA_MemoryInc_Enable;
  DMA_InitStructure.DMA_PeripheralDataSize    = DMA_PeripheralDataSize_Byte;
  DMA_InitStructure.DMA_MemoryDataSize        = DMA_MemoryDataSize_Byte;
  DMA_InitStructure.DMA_Mode                  = DMA_Mode_Normal;
  DMA_InitStructure.DMA_Priority              = DMA_Priority_Medium;
  DMA_InitStructure.DMA_FIFOMode              = DMA_FIFOMode_Disable;         
  DMA_InitStructure.DMA_FIFOThreshold         = DMA_FIFOThreshold_Full;
  DMA_InitStructure.DMA_MemoryBurst           = DMA_MemoryBurst_Single;
  DMA_InitStructure.DMA_PeripheralBurst       = DMA_PeripheralBurst_Single;
  DMA_Init(DMA2_Stream6, &DMA_InitStructure);
		
	USART_DMACmd(USART6, USART_DMAReq_Tx, ENABLE);
  USART_DMACmd(USART6, USART_DMAReq_Rx, ENABLE);

		
	//¡ä??¨²1??¨®|¨°y???¡ä¨®?¨®3¨¦?
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource9,GPIO_AF_USART1);
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource10,GPIO_AF_USART1); 
	
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource2,GPIO_AF_USART2); 
	GPIO_PinAFConfig(GPIOA,GPIO_PinSource3,GPIO_AF_USART2); 
	
	GPIO_PinAFConfig(GPIOB,GPIO_PinSource10,GPIO_AF_USART3); 
	GPIO_PinAFConfig(GPIOB,GPIO_PinSource11,GPIO_AF_USART3); 
	
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource10,GPIO_AF_UART4); 
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource11,GPIO_AF_UART4); 
	
	GPIO_PinAFConfig(GPIOC,GPIO_PinSource12,GPIO_AF_UART5); 
	GPIO_PinAFConfig(GPIOD,GPIO_PinSource2,GPIO_AF_UART5); 
	
	GPIO_PinAFConfig(GPIOG,GPIO_PinSource9,GPIO_AF_USART6); 
	GPIO_PinAFConfig(GPIOG,GPIO_PinSource14,GPIO_AF_USART6);

	

  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2|GPIO_Pin_3|GPIO_Pin_9 | GPIO_Pin_10; 
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;	
	GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; //¨ª?¨ª¨¬?¡ä¨®?¨º?3?
	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; //¨¦?¨¤-
	GPIO_Init(GPIOA,&GPIO_InitStructure);
  
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10|GPIO_Pin_11;
	GPIO_Init(GPIOB,&GPIO_InitStructure);
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10|GPIO_Pin_11|GPIO_Pin_12;
	GPIO_Init(GPIOC,&GPIO_InitStructure);	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;
	GPIO_Init(GPIOD,&GPIO_InitStructure);	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9|GPIO_Pin_14;
	GPIO_Init(GPIOG,&GPIO_InitStructure);
	
   
	USART_InitStructure.USART_BaudRate = bound1;
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//¡Á?3¡è?a8??¨ºy?Y??¨º?
	USART_InitStructure.USART_StopBits = USART_StopBits_1;//¨°???¨ª¡ê?1??
	USART_InitStructure.USART_Parity = USART_Parity_No;//?T????D¡ê?¨¦??
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//?T¨®2?t¨ºy?Y¨¢¡Â????
	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//¨º?¡¤¡é?¡ê¨º?
  USART_Init(USART1, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²1
	USART_Init(USART2, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²2
	USART_Init(USART3, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²3
	USART_Init(UART4, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²4
	USART_Init(UART5, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²5
	USART_InitStructure.USART_BaudRate = bound2;
	USART_Init(USART6, &USART_InitStructure); //3?¨º??¡¥¡ä??¨²6
	
  USART_Cmd(USART1, ENABLE);  //¨º1?¨¹¡ä??¨²1 
	USART_Cmd(USART2, ENABLE);  //¨º1?¨¹¡ä??¨²2
	USART_Cmd(USART3, ENABLE);  //¨º1?¨¹¡ä??¨²3
	USART_Cmd(UART4, ENABLE);   //¨º1?¨¹¡ä??¨²4
	USART_Cmd(UART5, ENABLE);   //¨º1?¨¹¡ä??¨²5
	USART_Cmd(USART6, ENABLE);  //¨º1?¨¹¡ä??¨²6
	
	USART_ClearFlag(USART1, USART_FLAG_TC);
	USART_ClearFlag(USART2, USART_FLAG_TC);
	USART_ClearFlag(USART3, USART_FLAG_TC);
	USART_ClearFlag(UART4, USART_FLAG_TC);
	USART_ClearFlag(UART5, USART_FLAG_TC);
	USART_ClearFlag(USART6, USART_FLAG_IDLE);
	

	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);//?a???¨®¨º??D??
	USART_ITConfig(USART2, USART_IT_RXNE, ENABLE);//?a???¨®¨º??D??
	USART_ITConfig(USART3, USART_IT_RXNE, ENABLE);//?a???¨®¨º??D??
	USART_ITConfig(UART4, USART_IT_RXNE, ENABLE);//?a???¨®¨º??D??
	USART_ITConfig(UART5, USART_IT_RXNE, ENABLE);//?a???¨®¨º??D??
	USART_ITConfig(USART6, USART_IT_IDLE, ENABLE);//?a?????D?D??

	//Usart1 NVIC ????
  NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=3;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority =3;		
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;		
	NVIC_Init(&NVIC_InitStructure);
  NVIC_InitStructure.NVIC_IRQChannel = USART2_IRQn;
  NVIC_Init(&NVIC_InitStructure);
  NVIC_InitStructure.NVIC_IRQChannel = USART3_IRQn;
  NVIC_Init(&NVIC_InitStructure);
  NVIC_InitStructure.NVIC_IRQChannel = UART4_IRQn;
  NVIC_Init(&NVIC_InitStructure);
  NVIC_InitStructure.NVIC_IRQChannel = UART5_IRQn;
  NVIC_Init(&NVIC_InitStructure);
  NVIC_InitStructure.NVIC_IRQChannel = USART6_IRQn;
  NVIC_Init(&NVIC_InitStructure);
	
}

/*¡¤¡é?¨ª¨ºy?Y?¨¹D?*/
u16 MsgUpdate(char *Data)
{
	char *Packgage = TxDebugMsg;
	u16 length = 0;
	while (*Data)
	{
		*Packgage++ = *Data++;
		length++;
	}
	return length;  /*¡¤¦Ì??¨ºy?Y3¡è?¨¨*/
}

/*¦Ì¨¨¡äyESP82663?¨º??¡¥¨ª¨º3¨¦*/
void WaitForESP8266Ready(void)
{

	while (1)
	{
		if (RecFrom8266)
		{
			//if (strcmp(RxDebugMsg[],"invalid\r\n\0") == 0)
			if (RxDebugMsg[35] == 'i')
			{
				OLED_Print6x8Str(00, 20, 103, 8, (uint8_t *)"ESP8266 is Ready!", INV_OFF, IS);
				return;
			}
			else
			{
				OLED_Print6x8Str(00, 20, 109, 8, (uint8_t *)"Waiting ESP8266...", INV_OFF, IS);
			}
			RecFrom8266 = 0;
		}
	}
}

/*¨¢??¨®?¨¢???¡§¦Ì?¡¤t???¡Â*/
/*protocol?¨¦???¦Ì  "TCP"  "UDP"*/
/*ip:   ¡¤t???¡Â¦Ì?IP¦Ì??¡¤*/
/*port: ¡¤t???¡Â?a¦Ì????¨²*/
void ESP8266_ConnectServer(char *protocol,char *ip,char *port)
{
	char CommStr[50] = "AT+CIPSTART=\"";
	u16 Num;	
	strcat(CommStr,protocol);
	strcat(CommStr,"\",\"");
	strcat(CommStr,ip);
	strcat(CommStr,"\",");
	strcat(CommStr,port);
	strcat(CommStr,"\r\n");
	
	Num = MsgUpdate(CommStr);
	DebugMsgSend(Num);
	
	/*¨¨£¤¦Ì?¦Ì¨²¨°?¡ä??D¦Ì?¦Ì¡ã¨¬?¦Ì?D??¡é*/
	RecFrom8266 = 0;
	while (!RecFrom8266){}; 
	/*¦Ì¨¨¡äy¨®|¡äe*/
	RecFrom8266 = 0;
	while (1)
	{
		if (RecFrom8266)
		{
			if (strcmp(RxDebugMsg,"CONNECT\r\n\r\nOK\r\n") == 0)
			{
				OLED_Print6x8Str(00, 30, 97, 8, (uint8_t *)"Server is Ready!", INV_OFF, IS);
				return;
			}
			else 
			{
				OLED_Print6x8Str(00, 30, 85, 8, (uint8_t *)"Wait Server...", INV_OFF, IS);
				DebugMsgSend(Num);
	      /*¨¨£¤¦Ì?¦Ì¨²¨°?¡ä??D¦Ì?¦Ì¡ã¨¬?¦Ì?D??¡é*/
	      RecFrom8266 = 0;
	      while (!RecFrom8266){}; 
			}
			RecFrom8266 = 0;
		}

	}
}

/*?a??ESP8266¦Ì?¨ª?¡ä?*/
void ESP8266_StartTrans(void)
{
	char CommStr[50] = "AT+CIPMODE=1\r\n";
	u16 Num;	
	
	Num = MsgUpdate(CommStr);
	DebugMsgSend(Num);
	
	
	/*¨¨£¤¦Ì?¦Ì¨²¨°?¡ä??D¦Ì?¦Ì¡ã¨¬?¦Ì?D??¡é*/
	RecFrom8266 = 0;
	while (!RecFrom8266){}; 
	/*¦Ì¨¨¡äy¨®|¡äe*/
	RecFrom8266 = 0;
	while (1)
	{
		if (RecFrom8266)
		{
			if (strcmp(RxDebugMsg,"\r\nOK\r\n") == 0)
			{
				OLED_Print6x8Str(00, 40, 91, 8, (uint8_t *)"Trans is Ready!", INV_OFF, IS);
				break;
			}
			else
			{
				OLED_Print6x8Str(00, 40, 79, 8, (uint8_t *)"Wait Trans...", INV_OFF, IS);
			}
			RecFrom8266 = 0;
		}
	}
	
	strcpy(CommStr,"AT+CIPSEND\r\n");
	Num = MsgUpdate(CommStr);
	DebugMsgSend(Num);	
		
	/*¦Ì¨¨¡äy¨®|¡äe*/
	RecFrom8266 = 0;
	while (1)
	{
		if (RecFrom8266)
		{
			if (strcmp(RxDebugMsg,"AT+CIPSEND\r\r\n\r\nOK\r\n\r\n>") == 0)
			{
				OLED_Print6x8Str(00, 50, 85, 8, (uint8_t *)"Send is Ready!", INV_OFF, IS);
				return;
			}
			else
			{
				OLED_Print6x8Str(00, 50, 73, 8, (uint8_t *)"Wait Send...", INV_OFF, IS);
			}
			RecFrom8266 = 0;
		}
	}	
}

void ESP8266_StopTrans(void)
{
	char CommStr[50] = "+++";
	u16 Num;	
	
	Num = MsgUpdate(CommStr);
	DebugMsgSend(Num);		
}

/*¨¢??¨®???¡§WIFI¦Ì?SSID*/
void ESP8266_ConnectWIFI(char *ssid,char *password)
{  
	char CommStr[50] = "AT+CWJAP=\"";
	u16 Num;
	strcat(CommStr,ssid);
	strcat(CommStr,"\",\"");
	strcat(CommStr,password);
	strcat(CommStr,"\"");
	strcat(CommStr,"\r\n");
	
	Num = MsgUpdate(CommStr);
	DebugMsgSend(Num);
	
	/*¦Ì¨¨¡äy¨®|¡äe*/
	RecFrom8266 = 0;
	while (1)
	{
		if (RecFrom8266)
		{
			if (strcmp(RxDebugMsg,"\r\nOK\r\n") == 0)
			{
				OLED_Print6x8Str(00, 20, 85, 8, (uint8_t *)"WIFI CONNECTED", INV_OFF, IS);
				return;
			}
			else 
			{
				OLED_Print6x8Str(00, 20, 79, 8, (uint8_t *)"Waiting IP...", INV_OFF, IS);
			}
			RecFrom8266 = 0;
		}
	}
	
}

/*?a??¨¤¡ä¡Á?8266¦Ì?¨ºy?Y?¨¹¨¢?*/
u8 ESP8266_Decode(void)
{
	return RxDebugMsg[0] - 48;
}

/*¦Ì¡Â¨º?D??¡é¨º?3?*/
void DebugMsgSend(u16 Num)
{
  if(DMA2_Stream6->NDTR)   
  {
      return;  /*DMA?y?¨²¡¤¡é?¨ª¨ºy?Y*/
  }
	DMA_Cmd(DMA2_Stream6, DISABLE);                      
	while (DMA_GetCmdStatus(DMA2_Stream6) != DISABLE){}		
	DMA_ClearFlag(DMA2_Stream6, DMA_FLAG_TCIF6 | DMA_FLAG_HTIF3);	
	DMA_SetCurrDataCounter(DMA2_Stream6,Num);          
	DMA_Cmd(DMA2_Stream6, ENABLE);                      
}



//RecStatus¨®D¨¨y??
//     bit2               bit1                bit0
//¨º?¡¤??¨®¨º?¦Ì?¨¢?0x0D   ¨º?¡¤??¨®¨º?¦Ì?¨¢?0x0A  ?a¨º??¨®¨º?¡À¨º??¡ê?1¡À¨ª¨º??a¨º??¨®¨º?
u8 RecStatus = 0;
u8 RecFromUsart = 0;
u8 RecFrom8266 = 0;
char RecBuf[600];

u8 USART_RX_STA2 = 0;
u8  USART_RX_BUF2[5];
u8 USART_RX_STA3 = 0;
u8  USART_RX_BUF3[5];
u8 USART_RX_STA4 = 0;
u8  USART_RX_BUF4[5];
u8 USART_RX_STA5 = 0;
u8  USART_RX_BUF5[5];

void USART1_IRQHandler(void)                	
{
	static u16 Num = 0;
	u8 Res;
	if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)  
	{
		Res = USART_ReceiveData(USART1);

    if (RecStatus & 0x01)  //¨º?¡¤??a¨º??¨®¨º?
		{  
			if (RecStatus&0x02)  //¨º?¡¤?¨°??-?¨®¨º?¦Ì?¨¢?0x0A
			{
				if (Res == 0x0D)   //?¨®¨º?¨¢?0x0A??o¨®?¨´?¨®¨º?¦Ì?0x0D¡ê??¦Ì?¡Â?¨®¨º?¨ª¨º3¨¦¨°???¨ºy?Y¡ã¨¹
				{
					RecFromUsart = 1;
					Manifold_CNT++;
					Num = 0;
					RecStatus = 0;
				}
				else
				{
					RecBuf[Num++] = Res; //?y3¡ê?¨®¨º?¨ºy?Y
					RecStatus = 0x01;    //??3y¨°??¨®¨º?¦Ì?0x0A¦Ì?¡À¨º??
					if (Num >= 500)      //?¨®¨º?¨ºy?Y3¡è?¨¨1y3¡è¡ê??¨®¨º?¡ä¨ª?¨®
					{
					  RecFromUsart = 0;
					  Num = 0;
					  RecStatus = 0;						
					}
				}
			}
			else
			{
          RecBuf[Num++] = Res; //?y3¡ê?¨®¨º?¨ºy?Y
					if (Num >= 500)      //?¨®¨º?¨ºy?Y3¡è?¨¨1y3¡è¡ê??¨®¨º?¡ä¨ª?¨®
					{
					  RecFromUsart = 0;
					  Num = 0;
					  RecStatus = 0;						
					}
			}
		  if (Res == 0x0A) RecStatus |= 1<<1;  //¡Á?¡À??D???¨®¨º?	
		}
		else
		{
			if (Res == 0x0D) RecStatus |= 1<<2;  //¡Á?¡À??a¨º??¨®¨º?
			else
				if ((Res == 0x0A) && (RecStatus&0x04))
					RecStatus = 0x01; //?a¨º??¨®¨º?
		}
  } 

} 

void USART2_IRQHandler(void)                	
{
	u8 Res;
	if(USART_GetITStatus(USART2, USART_IT_RXNE) != RESET)  
	{
		Res = USART_ReceiveData(USART2);	//?¨¢¨¨??¨®¨º?¦Ì?¦Ì?¨ºy?Y
		USART_RX_BUF2[USART_RX_STA2++] = Res;	   	
    UltraSonic1_CNT++;		
  } 

} 
	
void USART3_IRQHandler(void)                
{
	u8 Res;
	
	if(USART_GetITStatus(USART3, USART_IT_RXNE) != RESET)  
	{
		Res = USART_ReceiveData(USART3);	//?¨¢¨¨??¨®¨º?¦Ì?¦Ì?¨ºy?Y
		USART_RX_BUF3[USART_RX_STA3++] = Res;	  
    UltraSonic2_CNT++;		
  } 

} 
	
void UART4_IRQHandler(void)                
{
	u8 Res;
	if(USART_GetITStatus(UART4, USART_IT_RXNE) != RESET)  
	{
		Res = USART_ReceiveData(UART4);	//?¨¢¨¨??¨®¨º?¦Ì?¦Ì?¨ºy?Y
		USART_RX_BUF4[USART_RX_STA4++] = Res;	
    UltraSonic3_CNT++;		
  } 

} 
	
void UART5_IRQHandler(void)                
{
	u8 Res;
	if(USART_GetITStatus(UART5, USART_IT_RXNE) != RESET)  
	{
		Res = USART_ReceiveData(UART5);	//?¨¢¨¨??¨®¨º?¦Ì?¦Ì?¨ºy?Y
		USART_RX_BUF5[USART_RX_STA5++] = Res;	
    UltraSonic4_CNT++;		
  } 

} 

/**
  * ¡ä??¨²???D?D??
  * ?¨²?¨®¦Ì?¨ºy?Y¨°?o¨®¡ê??¨¬2a?¨®??¨¤¡ä¦Ì?¨°???¡Á??¨²?¨²¨®D??¨®D¨ºy?Y
  * ¨¨?1???¨®D¡ê??¨°IDLE??1¡ê?2¨²¨¦¨²?D??
  * ?¨¢¨¨?SRo¨ªDR??¡ä??¡Â?¨¦??3yIDLE¡À¨º????
  */
void USART6_IRQHandler(void)                
{
  u8 Res;
	/*??3yIDLE??¡ä??¡Â*/
	Res = USART6->SR;
	Res = USART6->DR;
  
  /*?¨®¨º?????*/	
  RecFrom8266 = 1;   
	
	/*2?¨¨??¨¢¨º?¡¤?,2?¨¨?¨ª¨º¦Ì¡ã*/
  Res = DEBUG_MSG_LENGTH - DMA2_Stream1->NDTR;
	RxDebugMsg[Res] = '\0';
	
	/*????DMA*/
	DMA_Cmd(DMA2_Stream1, DISABLE);
  DMA_ClearFlag(DMA2_Stream1, DMA_FLAG_TCIF1 | DMA_FLAG_HTIF1);
  while(DMA_GetCmdStatus(DMA2_Stream1) != DISABLE);
  DMA_SetCurrDataCounter(DMA2_Stream1, DEBUG_MSG_LENGTH);
  DMA_Cmd(DMA2_Stream1, ENABLE);
	
} 
 



